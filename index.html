<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Epazote by nbari</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Epazote</h1>
      <h2 class="project-tagline">Automated Microservices  Supervisor</h2>
      <a href="https://github.com/nbari/epazote" class="btn">View on GitHub</a>
      <a href="https://github.com/nbari/epazote/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/nbari/epazote/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p><a href="https://bintray.com/nbari/epazote/epazote/_latestVersion"><img src="https://api.bintray.com/packages/nbari/epazote/epazote/images/download.svg" alt="Download"></a>
<a href="https://drone.io/github.com/nbari/epazote/latest"><img src="https://drone.io/github.com/nbari/epazote/status.png" alt="Build Status"></a>
<a href="https://travis-ci.org/nbari/epazote"><img src="https://travis-ci.org/nbari/epazote.svg?branch=develop" alt="Build Status"></a>
<a href="https://coveralls.io/github/nbari/epazote?branch=master"><img src="https://coveralls.io/repos/github/nbari/epazote/badge.svg?branch=master" alt="Coverage Status"></a></p>

<h1>
<a id="epazote-" class="anchor" href="#epazote-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Epazote <g-emoji alias="herb" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f33f.png">ðŸŒ¿</g-emoji>
</h1>

<p>Automated Microservices Supervisor</p>

<p><strong>Epazote</strong> automatically update/add services specified in a file call
<code>epazote.yml</code>. Periodically checks the defined endpoints and execute recovery
commands in case services responses are not behaving like expected helping with
this to automate actions in order to keep services/applications up and running.</p>

<p>In Continuous Integration/Deployment environments the file <code>epazote.yml</code> can
dynamically be updated/change without need to restart the supervisor, avoiding
with this an extra dependency on the deployment flow which could imply to
restart the supervisor, in this case <strong>Epazote</strong>.</p>

<h2>
<a id="how-it-works" class="anchor" href="#how-it-works" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How it works</h2>

<p>In its basic way of operation, <strong>Epazote</strong> periodically checks the services endpoints
"<a href="https://en.wikipedia.org/wiki/Uniform_Resource_Locator">URLs</a>"
by doing an <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods">HTTP GET Request</a>,
based on the response <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">Status code</a>,
<a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields">Headers</a> or
either the
<a href="https://en.wikipedia.org/wiki/HTTP_message_body">body</a>, it executes a command.</p>

<p>In most scenarios, is desired to apply a command directly to the application in
cause, like a signal (<code>kill -HUP</code>), or either a restart (<code>sv restart app</code>),
therefore in this case <strong>Epazote</strong> and the application should be running on the
same server.</p>

<p><strong>Epazote</strong> can also work in a standalone mode by only monitoring and sending
alerts if desired.</p>

<h1>
<a id="how-to-use-it" class="anchor" href="#how-to-use-it" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to use it</h1>

<p>First you need to install <strong>Epazote</strong>, either you can compile it from
<a href="https://github.com/nbari/epazote">source</a>
or download a pre-compiled binary matching your operating system from here:
<a href="https://dl.bintray.com/nbari/epazote/">https://dl.bintray.com/nbari/epazote/</a></p>

<p><a href="https://bintray.com/nbari/epazote/epazote/_latestVersion"><img src="https://api.bintray.com/packages/nbari/epazote/epazote/images/download.svg" alt="Download"></a></p>

<blockquote>
<p>To compile from source, after downloading the sources use <code>make</code> to build the binary</p>
</blockquote>

<p><strong>Epazote</strong> was designed with simplicity in mind, as an easy tool for
<a href="https://en.wikipedia.org/wiki/DevOps">DevOps</a> and as a complement to
infrastructure orchestration tools like <a href="http://www.ansible.com/">Ansible</a> and
<a href="http://saltstack.com/">SaltStack</a>, because of this <a href="http://www.yaml.org/">YAML</a>
is used for the configuration files, avoiding with this, the learn of a new
language or syntax and simplifying the setup.</p>

<h2>
<a id="basic-example" class="anchor" href="#basic-example" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Basic example</h2>

<div class="highlight highlight-source-yaml"><pre><span class="pl-s"><span class="pl-ent">services:</span></span>
    <span class="pl-s"><span class="pl-ent">google:</span></span>
        <span class="pl-s"><span class="pl-ent">url:</span> <span class="pl-s">http://www.google.com</span></span>
        <span class="pl-c1"><span class="pl-ent">seconds:</span> 5</span>
        <span class="pl-s"><span class="pl-ent">expect:</span></span>
            <span class="pl-c1"><span class="pl-ent">status:</span> 200</span>
            <span class="pl-s"><span class="pl-ent">if_not:</span></span>
                <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">echo -n "google down"</span></span></pre></div>

<p>To supervise <code>google</code> you would run (basic.yml is a file containing the above code):</p>

<pre><code>$ epazote -f /path/to/yaml/file/basic.yml -d
</code></pre>

<blockquote>
<p>-d is for debugging, will print all output to standard output.</p>
</blockquote>

<p>This basic setup will supervise every 5 seconds the service with name
<code>google</code>, it will do an HTTP GET to <code>http://www.google.com</code> and will expect
an <code>200 Status code</code> if not,  it will <code>echo -n "google down"</code></p>

<p>Extending the basic example for receiving notifications:</p>

<div class="highlight highlight-source-yaml"><pre><span class="pl-s"><span class="pl-ent">config:</span></span>
    <span class="pl-s"><span class="pl-ent">smtp:</span></span>
        <span class="pl-s"><span class="pl-ent">username:</span> <span class="pl-s">smtp@domain.tld</span></span>
        <span class="pl-s"><span class="pl-ent">password:</span> <span class="pl-s">password</span></span>
        <span class="pl-s"><span class="pl-ent">server:</span> <span class="pl-s">mail.example.com</span></span>
        <span class="pl-c1"><span class="pl-ent">port:</span> 587</span>
        <span class="pl-s"><span class="pl-ent">headers:</span></span>
            <span class="pl-s"><span class="pl-ent">from:</span> <span class="pl-s">you@domain.tld</span></span>
            <span class="pl-s"><span class="pl-ent">to:</span> <span class="pl-s">team@domain.tld</span></span>
            <span class="pl-s"><span class="pl-ent">subject:</span> <span class="pl-s"><span class="pl-pds">"</span>[name - exit- status]<span class="pl-pds">"</span></span></span>

<span class="pl-s"><span class="pl-ent">services:</span></span>
    <span class="pl-s"><span class="pl-ent">google:</span></span>
        <span class="pl-s"><span class="pl-ent">url:</span> <span class="pl-s">http://www.google.com</span></span>
        <span class="pl-c1"><span class="pl-ent">minutes:</span> 3</span>
        <span class="pl-s"><span class="pl-ent">expect:</span></span>
            <span class="pl-c1"><span class="pl-ent">status:</span> 200</span>
            <span class="pl-s"><span class="pl-ent">if_not:</span></span>
                <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">echo -n "google down"</span></span>
                <span class="pl-s"><span class="pl-ent">notify:</span> <span class="pl-s">yes</span></span></pre></div>

<p>In this case, every 3 minutes the service will be checked and in case of not
receiving a <code>200 Status code</code>, besides executing the command: <code>echo -n
"google down"</code> an email is going to be send to <code>team@domain.tld</code>, this
because of the <code>notify: yes</code> setting.</p>

<h2>
<a id="the-configuration-file" class="anchor" href="#the-configuration-file" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The configuration file</h2>

<p>The configuration file (<a href="https://en.wikipedia.org/wiki/YAML">YAML formated</a>)
consists of two parts, a <strong>config</strong> and a <strong>services</strong> (Key-value pairs).</p>

<h2>
<a id="the-config-section" class="anchor" href="#the-config-section" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The config section</h2>

<p>The <strong>config</strong> section is composed of:</p>

<pre><code>- smtp (Email settings for sending notification)
- scan (Paths used to find the file 'epazote.yml')
</code></pre>

<p>Example:</p>

<div class="highlight highlight-source-yaml"><pre><span class="pl-s"><span class="pl-ent">config:</span></span>
    <span class="pl-s"><span class="pl-ent">smtp:</span></span>
        <span class="pl-s"><span class="pl-ent">username:</span> <span class="pl-s">smtp@domain.tld</span></span>
        <span class="pl-s"><span class="pl-ent">password:</span> <span class="pl-s">password</span></span>
        <span class="pl-s"><span class="pl-ent">server:</span> <span class="pl-s">mail.example.com</span></span>
        <span class="pl-c1"><span class="pl-ent">port:</span> 587</span>
        <span class="pl-s"><span class="pl-ent">headers:</span></span>
            <span class="pl-s"><span class="pl-ent">from:</span> <span class="pl-s">epazote@domain.tld</span></span>
            <span class="pl-s"><span class="pl-ent">to:</span> <span class="pl-s">team@domain.tld ops@domain.tld etc@domain.tld</span></span>
            <span class="pl-s"><span class="pl-ent">subject:</span> <span class="pl-s"><span class="pl-pds">"</span>[name - status]<span class="pl-pds">"</span></span></span>
    <span class="pl-s"><span class="pl-ent">scan:</span></span>
        <span class="pl-s"><span class="pl-ent">paths:</span></span>
            <span class="pl-s">- <span class="pl-s">/arena/home/sites</span></span>
            <span class="pl-s">- <span class="pl-s">/home/apps</span></span>
        <span class="pl-c1"><span class="pl-ent">minutes:</span> 5</span></pre></div>

<h3>
<a id="config---smtp" class="anchor" href="#config---smtp" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>config - smtp</h3>

<p>Required to properly send alerts via email, all fields are required, the
<code>headers</code> section can be extended with any desired key-pair values.</p>

<h3>
<a id="config---smtp---subject-because-exit-name-output-status-url" class="anchor" href="#config---smtp---subject-because-exit-name-output-status-url" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>config - smtp - subject (because exit name output status url)</h3>

<p>The subject can be formed by using this keywords: <code>because</code> <code>exit</code> <code>name</code>
<code>output</code> <code>status</code> <code>url</code> on the previous example, <code>subject: [name - status]</code>
would transform to <code>[my service - 500]</code> the <code>name</code> has replaced
by the service name, <code>my service</code> and <code>status</code> by the response status code
<code>500</code> in this case.</p>

<h3>
<a id="config---scan" class="anchor" href="#config---scan" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>config - scan</h3>

<p>Paths to scan every N <code>seconds</code>, <code>minutes</code> or <code>hours</code>, a search for
services specified in a file call <code>epazote.yml</code> is made.</p>

<p>The <strong>scan</strong> setting is optional however is very useful when doing Continues
Deployments. for example if your code is automatically uploaded to the
directory <code>/arena/home/sites/application_1</code> and your scan paths contain
<code>/arena/home/sites</code>, you could simple upload on your application directory a
file named <code>epazote.yml</code> with the service rules, thus achieving the deployment
of your application and the supervising at the same time.</p>

<h3>
<a id="config-optional" class="anchor" href="#config-optional" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>config (optional)</h3>

<p>As you may notice the <code>config</code> section contains mainly settings for sending
alerts/notifications apart from the <code>scan</code> setting, therefore is totally
optional, meaning that <strong>Epazote</strong> can still run and check your services without
the need of the <code>config</code> section.</p>

<p>If you want to automatically update/load services you will need the
<code>config - scan</code> setting.</p>

<h2>
<a id="the-services-section" class="anchor" href="#the-services-section" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The services section</h2>

<p>Services are the main functionality of <strong>Epazote</strong>, is where the URL's and the
rules based on the response are defined, since options vary from service to
service, an example could help better to understand the setup:</p>

<div class="highlight highlight-source-yaml"><pre><span class="pl-s"><span class="pl-ent">services:</span></span>
    <span class="pl-s"><span class="pl-ent">my service 1:</span></span>
        <span class="pl-s"><span class="pl-ent">url:</span> <span class="pl-s">http://myservice.domain.tld/_healthcheck_</span></span>
        <span class="pl-c1"><span class="pl-ent">timeout:</span> 5</span>
        <span class="pl-c1"><span class="pl-ent">seconds:</span> 60</span>
        <span class="pl-s"><span class="pl-ent">log:</span> <span class="pl-s">http://monitor.domain.tld</span></span>
        <span class="pl-s"><span class="pl-ent">expect:</span></span>
            <span class="pl-c1"><span class="pl-ent">status:</span> 200</span>
            <span class="pl-s"><span class="pl-ent">header:</span></span>
                <span class="pl-s"><span class="pl-ent">content-type:</span> <span class="pl-s">application/json</span></span>
            <span class="pl-s"><span class="pl-ent">body:</span> <span class="pl-s">find this string on my site</span></span>
            <span class="pl-s"><span class="pl-ent">if_not:</span></span>
                <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">sv restart /services/my_service_1</span></span>
                <span class="pl-s"><span class="pl-ent">notify:</span> <span class="pl-s">team@domain.tld</span></span>
<span class="pl-s">                <span class="pl-ent">msg:</span> |</span>
<span class="pl-s">                    line 1 bla bla</span>
<span class="pl-s">                    line 2</span>
<span class="pl-s"></span>        <span class="pl-s"><span class="pl-ent">if_status:</span></span>
            <span class="pl-s"><span class="pl-ent">500:</span></span>
                <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">reboot</span></span>
            <span class="pl-s"><span class="pl-ent">404:</span></span>
                <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">sv restart /services/cache</span></span>
                <span class="pl-s"><span class="pl-ent">msg:</span> <span class="pl-s">restarting cache</span></span>
                <span class="pl-s"><span class="pl-ent">notify:</span> <span class="pl-s">team@domain.tld x@domain.tld</span></span>
        <span class="pl-s"><span class="pl-ent">if_header:</span></span>
            <span class="pl-s"><span class="pl-ent">x-amqp-kapputt:</span></span>
                <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">restart abc</span></span>
                <span class="pl-s"><span class="pl-ent">notify:</span> <span class="pl-s">bunny@domain.tld</span></span>
<span class="pl-s">                <span class="pl-ent">msg:</span> |</span>
<span class="pl-s">                    The rabbit is angry</span>
<span class="pl-s">                    &amp; hungry</span>
<span class="pl-s"></span>            <span class="pl-s"><span class="pl-ent">x-db-kapputt:</span></span>
                <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">svc restart /services/db</span></span>

    <span class="pl-s"><span class="pl-ent">other service:</span></span>
        <span class="pl-s"><span class="pl-ent">url:</span> <span class="pl-s">http://other-service.domain.tld/ping</span></span>
        <span class="pl-c1"><span class="pl-ent">minutes:</span> 3</span>

    <span class="pl-s"><span class="pl-ent">redirect service:</span></span>
        <span class="pl-s"><span class="pl-ent">url:</span> <span class="pl-s">http://test.domain.tld/</span></span>
        <span class="pl-s"><span class="pl-ent">follow:</span> <span class="pl-s">yes</span></span>
        <span class="pl-c1"><span class="pl-ent">hour:</span> 1</span>
        <span class="pl-s"><span class="pl-ent">expect:</span></span>
            <span class="pl-c1"><span class="pl-ent">status:</span> 302</span>
            <span class="pl-s"><span class="pl-ent">if_not:</span></span>
                <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">service restart abc</span></span>
                <span class="pl-s"><span class="pl-ent">notify:</span> <span class="pl-s">yes</span></span>

    <span class="pl-s"><span class="pl-ent">salt-master:</span></span>
        <span class="pl-s"><span class="pl-ent">test:</span> <span class="pl-s">pgrep -f salt</span></span>
        <span class="pl-s"><span class="pl-ent">if_not:</span></span>
            <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">service restart salt_master</span></span>
            <span class="pl-s"><span class="pl-ent">notify:</span> <span class="pl-s">operations@domain.tld</span></span></pre></div>

<h3>
<a id="services---name-of-service-string" class="anchor" href="#services---name-of-service-string" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - name of service (string)</h3>

<p>An unique string that identifies your service, in the above example, there are 3
services named:</p>

<ul>
<li>my service 1</li>
<li>other service</li>
<li>redirect service</li>
</ul>

<h3>
<a id="services---url-string" class="anchor" href="#services---url-string" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - url (string)</h3>

<p>URL of the service to supervise</p>

<h3>
<a id="services---follow-boolean-truefalse" class="anchor" href="#services---follow-boolean-truefalse" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - follow (boolean true/false)</h3>

<p>By default if a <a href="https://en.wikipedia.org/wiki/HTTP_302">302 Status code</a> is
received, <strong>Epazote</strong> will not follow it, if you would like to follow all
redirects, this setting must be set to <strong>true</strong>.</p>

<h3>
<a id="services---timeout-in-seconds-int" class="anchor" href="#services---timeout-in-seconds-int" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - timeout in seconds (int)</h3>

<p>Timeout specifies a time limit for the HTTP requests, A value of zero means no
timeout, defaults to 5 seconds.</p>

<h3>
<a id="services---seconds-minutes-hours" class="anchor" href="#services---seconds-minutes-hours" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - seconds, minutes, hours</h3>

<p>How often to check the service, the options are: (Only one should be used)</p>

<ul>
<li>seconds N</li>
<li>minutes N</li>
<li>hours N</li>
</ul>

<p><code>N</code> should be an integer.</p>

<h3>
<a id="services---log-url" class="anchor" href="#services---log-url" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - log (URL)</h3>

<p>An URL to post all events, default disabled.</p>

<h3>
<a id="services---expect" class="anchor" href="#services---expect" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - expect</h3>

<p>The <code>expect</code> block options are:</p>

<ul>
<li>status (int)</li>
<li>header (string)</li>
<li>body   (regular expression)</li>
<li>if_not (Action block)</li>
</ul>

<h3>
<a id="services---expect---status" class="anchor" href="#services---expect---status" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - expect - status</h3>

<p>An Integer representing the expected <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">HTTP Status Code</a></p>

<h3>
<a id="services---expect---header-start_with-match" class="anchor" href="#services---expect---header-start_with-match" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - expect - header (start_with match)</h3>

<p>A key-value map of expected headers, it can be only one or more.</p>

<p>The headers will be considered valid if they starts with the required value,
for example if you want to check for <code>Content-type: application/json; charset=utf-8</code>
you can simple do something like:</p>

<div class="highlight highlight-source-yaml"><pre>    <span class="pl-s"><span class="pl-ent">header:</span></span>
        <span class="pl-s"><span class="pl-ent">Content-Type:</span> <span class="pl-s">application/json</span></span></pre></div>

<p>This helps to simplify the matching and useful in cases where the headers
changes, for example: <code>Content-Range: bytes 100-64656926/64656927</code> can be
matched with:</p>

<div class="highlight highlight-source-yaml"><pre>    <span class="pl-s"><span class="pl-ent">header:</span></span>
        <span class="pl-s"><span class="pl-ent">Content-Range:</span> <span class="pl-s">bytes</span></span></pre></div>

<h3>
<a id="services---expect---body" class="anchor" href="#services---expect---body" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - expect - body</h3>

<p>A <a href="https://en.wikipedia.org/wiki/Regular_expression">regular expression</a> used
to match a string on the body of the site, use full in cases you want to ensure
that the content delivered is always the same or keeps a pattern.</p>

<h3>
<a id="services---expect-how-it-works" class="anchor" href="#services---expect-how-it-works" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - expect (How it works)</h3>

<p>The <code>expect</code> logic tries to implement a
<a href="https://en.wikipedia.org/wiki/if_else">if-else</a> logic <code>status</code>, <code>header</code>,
<code>body</code> are the <strong>if</strong> and the <code>if_not</code> block becomes the <strong>else</strong>.</p>

<pre><code>if
    status
    header
    body
else:
    if_not
</code></pre>

<p>In must cases only one option is required, check on the above example for the service named "redirect service".</p>

<p>In case that more than one option is used, this is the order in how they are evaluated, no meter how they where introduced on the configuration file:</p>

<pre><code>1. body
2. status
3. header
</code></pre>

<p>The reason for this order is related to performance, at the end we want to
monitor/supervise the services in an efficient way avoiding to waste extra
resources, in must cases only the HTTP Headers are enough to take an action,
therefore we don't need to read the full body page, because of this if no
<code>body</code> is defined, <strong>Epazote</strong> will only read the Headers saving with this
time and process time.</p>

<h3>
<a id="services---expect---if_not" class="anchor" href="#services---expect---if_not" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - expect - if_not</h3>

<p><code>if_not</code> is a block with an action of what to do it we don't get what we where
expecting (<code>expect</code>). See services - Actions</p>

<h3>
<a id="services---if_status---if_header" class="anchor" href="#services---if_status---if_header" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - if_status  &amp; if_header</h3>

<p>There maybe cases in where third-party dependencies are down and because of this
your application could not be working properly, for this cases the <code>if_status</code>
and <code>if_header</code> could be useful.</p>

<p>For example if the database is your application could start responding an status
code 500 or either a custom header and based on does values take execute an
action:</p>

<p>The format for <code>if_status</code> is a key-pair where key is an int representing an
HTTP status code, and the value an Action option</p>

<p>The format for <code>if_header</code> is a key-pair where key is a string of something
you could relate/match and has in other if_X conditions, value is an Action.</p>

<p>This are the only <code>if's</code> and the order of execution:</p>

<ol>
<li>if_status</li>
<li>if_header</li>
<li>if_not</li>
</ol>

<p>This means that if a service uses <code>if_status</code> and <code>if_not</code>, it will
evaluate first the <code>if_status</code> and execute an Action if required, in case
an <code>if_status</code> and <code>if_header</code> are set, same applies, first is evaluated
<code>if_status</code>, then <code>if_header</code> and last <code>if_not</code>.</p>

<h2>
<a id="services---actions" class="anchor" href="#services---actions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - Actions</h2>

<p>An Action has tree options:</p>

<ul>
<li>cmd</li>
<li>notify</li>
<li>msg</li>
</ul>

<p>They can be used all together, only one or either none.</p>

<h3>
<a id="services---actions---cmd-string" class="anchor" href="#services---actions---cmd-string" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - Actions - cmd (string)</h3>

<p><code>cmd</code> Contains the command to be executed.</p>

<h3>
<a id="services---actions---notify-string" class="anchor" href="#services---actions---notify-string" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - Actions - notify (string)</h3>

<p><code>notify</code> Should contain <code>yes</code>, the email email address or addresses (space separated)
of the recipients that will be notified when the action is executed.</p>

<p>If the string is <code>yes</code> the global recipients will be used.</p>

<h3>
<a id="services---actions---msg-string" class="anchor" href="#services---actions---msg-string" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - Actions - msg (string)</h3>

<p><code>msg</code> The message to send when the action is executed.</p>

<h2>
<a id="services---test" class="anchor" href="#services---test" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>services - Test</h2>

<p><strong>Epazote</strong> It is mainly used for HTTP services, for supervising other
applications that don't listen or accept HTTP connections, like a database,
cache engine, etc. There are tools like
<a href="https://cr.yp.to/daemontools.html">daemontools</a>,
<a href="http://smarden.org/runit/">runit</a> as already mentioned, even so, <strong>Epazote</strong>
can eventually be used to execute an action based on the exit of a command
for example:</p>

<div class="highlight highlight-source-yaml"><pre>    <span class="pl-s"><span class="pl-ent">salt-master:</span></span>
        <span class="pl-s"><span class="pl-ent">test:</span> <span class="pl-s">pgrep -f salt</span></span>
        <span class="pl-s"><span class="pl-ent">if_not:</span></span>
            <span class="pl-s"><span class="pl-ent">cmd:</span> <span class="pl-s">service restart salt_master</span></span>
            <span class="pl-s"><span class="pl-ent">notify:</span> <span class="pl-s">operations@domain.tld</span></span></pre></div>

<p>In this case: <code>test: pgrep -f salt</code> will execute the <code>cmd</code> on the <code>if_not</code>
block in case the exit code is &gt; 0, from the <code>pgrep</code> man page:</p>

<pre lang="txt"><code>EXIT STATUS
     The pgrep and pkill utilities return one of the following values upon exit:

          0       One or more processes were matched.
          1       No processes were matched.
          2       Invalid options were specified on the command line.
          3       An internal error occurred.
</code></pre>

<h2>
<a id="extra-setup" class="anchor" href="#extra-setup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Extra setup</h2>

<p><em>green dots give some comfort</em> -- Because of this when using the <code>log</code>
option an extra service could be configure as a receiver for all the post
that <strong>Epazote</strong> produce and based on the data obtained create a custom
dashboard, something similar to: <a href="https://status.cloud.google.com/">https://status.cloud.google.com/</a> or
<a href="http://status.aws.amazon.com/">http://status.aws.amazon.com/</a></p>

<h1>
<a id="issues" class="anchor" href="#issues" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Issues</h1>

<p>Please report any problem, bug, here: <a href="https://github.com/nbari/epazote/issues">https://github.com/nbari/epazote/issues</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/nbari/epazote">Epazote</a> is maintained by <a href="https://github.com/nbari">nbari</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
